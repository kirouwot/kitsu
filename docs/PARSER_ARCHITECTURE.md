# PARSER-ARCH-001 — Архитектура парсера и интеграция

Документ описывает целевую архитектуру парсера аниме для текущего backend без изменений существующей системы. Парсер проектируется как изолированный модуль-плагин: он добавляет свои таблицы, фоновые задачи и admin-эндпоинты, но не переписывает текущие use_cases и не меняет существующие таблицы.

## 1. Общая архитектура парсера

### 1.1. Модули и расположение
- `backend/app/parser/` — корневой модуль парсера (новый).
  - `parser/domain` — доменные модели парсинга (аниме, эпизод, источники, расписание) и правила нормализации.
  - `parser/sources` — адаптеры внешних источников (каталог, расписание, видео), каждый источник изолирован.
  - `parser/services` — сервисы синхронизации, матчинга и публикации.
  - `parser/repositories` — работа с новыми таблицами (`parser_*`, `anime_*`).
  - `parser/jobs` — фоновые задачи и планировщик (очередь/cron).
  - `parser/admin` — admin-эндпоинты и DTO для управления парсером.
  - `parser/config` — настройки источников, фильтры озвучек и качество.

### 1.2. Взаимодействие с backend
- Парсер подключается к backend как отдельный модуль и использует существующую инфраструктуру БД и FastAPI.
- Новые admin-эндпоинты размещаются под `/api/admin/parser/*` и используют существующий RBAC.
- Существующие бизнес-эндпоинты не изменяются; парсер работает через собственные сервисы и таблицы.
- Парсер может читать существующие записи каталога для сопоставления, но не модифицирует их без явного режима публикации.

### 1.3. Синхронные и фоновые части
- **Синхронно**: управление настройками парсера, запуск задач, просмотр логов и статусов, ручная привязка источников.
- **Фоново**: скачивание данных, нормализация, сохранение в новые таблицы, обновление расписания и эпизодов.
- Планировщик запускается в отдельном воркере/cron-процессе (без изменения текущих use_cases).

## 2. Источники данных (логически)

### 2.1. Типы источников
1. **Каталог (Shikimori-like)**
   - список аниме, названия (RU/EN/JP), описание, постер, жанры, студия, длительность, статус, сезон и год.
   - связи: сезонность, спин-оффы, приквелы/сиквелы.
2. **Расписание**
   - даты и время выхода эпизодов для онгоингов, календарь релизов.
3. **Видео (Kodik iframe)**
   - iframe-ссылки и метаданные по эпизодам (озвучка, качество, язык).

### 2.2. Сопоставление Shikimori ↔ Kodik ↔ внутренний ID
- Вводится таблица соответствий `anime_external` (внутренний `anime_id` ↔ `source_id`/`external_id`).
- Сопоставление выполняется по приоритету:
  1. Явные внешние ID (если известны из импортов/источников).
  2. Нормализованные названия + год/сезон.
  3. Ручная привязка через админку (обязательна при конфликте).
- Для Kodik хранится отдельная привязка эпизодов (`episode_number` ↔ `iframe_url`) и список доступных озвучек/качеств.

## 3. Модель данных (новые таблицы)

### 3.1. Таблицы управления парсером
- `parser_sources`
  - `id`, `code`, `name`, `base_url`, `enabled`, `rate_limit_per_min`, `max_concurrency`,
    `last_synced_at`, `created_at`, `updated_at`.
- `parser_settings`
  - `id`, `mode` (manual/auto), `dry_run`, `default_quality`, `allowed_translation_types`,
    `schedule_enabled`, `autopublish_enabled`, `updated_at`.
- `parser_jobs`
  - `id`, `source_id`, `job_type`, `status`, `priority`, `scheduled_at`, `started_at`,
    `finished_at`, `attempts`, `max_attempts`, `error_summary`, `payload_ref`, `created_by`.
- `parser_job_logs`
  - `id`, `job_id`, `level`, `message`, `created_at`.

### 3.2. Таблицы каталога/эпизодов (стейджинг)
- `anime_external`
  - `id`, `anime_id`, `source_id`, `external_id`, `external_slug`,
    `title_raw`, `match_confidence`, `matched_by` (auto/manual), `last_seen_at`.
- `anime_external_relations`
  - `id`, `anime_id`, `source_id`, `relation_type`, `related_external_id`, `relation_order`.
- `anime_schedule`
  - `id`, `anime_id`, `source_id`, `episode_number`, `air_datetime_utc`,
    `status` (announced/scheduled/aired), `last_checked_at`, `source_hash`.
- `anime_episodes_external`
  - `id`, `anime_id`, `source_id`, `episode_number`, `external_episode_id`,
    `iframe_url`, `available_qualities`, `available_translations`, `updated_at`.
- `anime_translations`
  - `id`, `anime_id`, `source_id`, `translation_code`, `translation_name`,
    `type` (voice/sub), `enabled`, `priority`, `updated_at`.

### 3.3. Связи
- `source_id` → `parser_sources.id`.
- `anime_id` → существующая таблица каталога (только чтение).
- `parser_job_logs.job_id` → `parser_jobs.id`.
- Все таблицы `anime_*` связаны с `anime_id` и одним источником `source_id`.

## 4. Автодобавление и расписание

### 4.1. Автодобавление новых аниме
- Ежедневная задача **catalog_discovery**:
  - получает новые записи из источника каталога;
  - сохраняет в `anime_external` и связанные таблицы;
  - при включённом `autopublish_enabled` готовит публикацию (без перезаписи существующих данных).
- Конфликты (несовпадение названий/годов) помечаются как `manual` и требуют подтверждения админа.

### 4.2. Автодобавление новых серий
- Периодическая задача **episode_sync** (каждые 30–60 минут):
  - работает только по активным онгоингам;
  - обновляет `anime_schedule` и `anime_episodes_external`;
  - фиксирует доступные озвучки/качества по правилам админки.

### 4.3. Частота и ограничения
- Планировщик поддерживает ограничение по источнику (`rate_limit_per_min`, `max_concurrency`).
- Для каждого аниме хранится `last_checked_at` и `source_hash`, чтобы избегать повторной загрузки без изменений.

## 5. Админка парсера

### 5.1. Экраны
- **Dashboard**: статус источников, активные/завершённые задачи, очередь, ошибки.
- **Sources**: включение/выключение источников, лимиты, проверки доступности.
- **Parser Settings**: режим manual/auto, dry-run, выбор качества, фильтр озвучек.
- **Anime Mapping**: список несопоставленных аниме, ручная привязка внешних ID.
- **Schedule**: календарь выхода серий, статус обновлений.
- **Logs**: ошибки и предупреждения парсинга.

### 5.2. Управление
- Включение/выключение автосинхронизации.
- Запуск задач вручную (полная синхронизация, обновление эпизодов).
- Приоритеты озвучек и языков.
- Разрешённые качества (например, только 720p/1080p).

## 6. Нагрузка и безопасность

### 6.1. Минимизация нагрузки
- Пакетная загрузка, delta-обновления по `last_checked_at`.
- Ограничение параллелизма на источник.
- Кэширование HTTP-ответов и поддержка условных запросов (ETag/If-Modified-Since).

### 6.2. Почему видео не нагружает сервер
- Backend хранит только iframe-URL и метаданные.
- Стриминг идёт напрямую через Kodik iframe; сервер не проксирует и не хранит видео.

### 6.3. Rate limits и retry-политика
- Лимиты на источник задаются в `parser_sources`.
- Повторы: до 3 попыток с линейным backoff и фиксацией ошибки в `parser_job_logs`.
- Ошибки источника не влияют на существующие данные; применяются только после успешной валидации.

## 7. Последовательность внедрения

1. **Parser dry-run**
   - сбор и нормализация данных без записи, тестирование матчинга и логирования.
2. **Parser write-mode**
   - запись в новые `parser_*` и `anime_*` таблицы, без изменений существующего каталога.
3. **Admin panel**
   - настройка источников, лимитов, выбор озвучек, ручная привязка.
4. **Autoupdate episodes**
   - включение расписания и автообновления онгоингов.
5. **Мониторинг**
   - алерты по ошибкам, мониторинг очереди и rate limits, отчётность по источникам.
